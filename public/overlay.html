<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Donation Goal Overlay</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 50px;
      box-sizing: border-box;
    }

    #wrap {
      width: 900px;
      max-width: 90vw;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
    }

    .title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--fg);
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
      text-align: center;
      opacity: 1;
      animation: fadeInUp 1s ease forwards;
    }

    .progress-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      opacity: 0;
      animation: fadeInUp 1s ease 0.2s forwards;
    }

    .progress-container {
      width: 80%;
      max-width: 700px;
      height: 60px;
      background: var(--bg);
      border-radius: 30px;
      overflow: hidden;
      box-shadow: 
        inset 0 0 0 3px rgba(255,255,255,0.1),
        0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--bar), var(--bar-light));
      width: 0%;
      transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      /* Shimmer only on hover/active for performance */
      animation: none;
      will-change: transform;
      transform: translateZ(0);
    }

    .progress-fill.animate::before {
      animation: shimmer 1.5s ease-out;
    }

    /* Cute liquid-filled circle gauge */
    .percentage-circle {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.3);
      border: 4px solid rgba(255, 255, 255, 0.2);
      box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.3),
        inset 0 2px 5px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      flex-shrink: 0;
    }

    /* Liquid fill inside circle */
    .liquid-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(180deg, var(--bar-light), var(--bar));
      transition: height 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Wave effect on liquid - simplified for performance */
    .liquid-fill::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 0;
      width: 100%;
      height: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      /* Removed infinite animation for performance */
    }

    .liquid-fill::after {
      display: none; /* Disabled second wave for performance */
    }

    @keyframes wave {
      0%, 100% {
        transform: translateX(0) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(-3px);
      }
    }

    /* Percentage text inside circle */
    .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #ffffff;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 10;
      white-space: nowrap;
    }

    /* Shimmer effect on circle when progress updates */
    .percentage-circle.update {
      animation: circleShimmer 0.6s ease;
    }

    @keyframes circleShimmer {
      0%, 100% {
        box-shadow: 
          0 4px 15px rgba(0, 0, 0, 0.3),
          inset 0 2px 5px rgba(0, 0, 0, 0.5);
      }
      50% {
        box-shadow: 
          0 4px 20px var(--bar),
          inset 0 2px 5px rgba(0, 0, 0, 0.5),
          0 0 20px var(--bar);
      }
    }

    .amount-info {
      margin-top: 12px;
      text-align: center;
      color: var(--fg);
      font-size: 20px;
      font-weight: 500;
      text-shadow: 0 0 6px rgba(0,0,0,0.5);
      opacity: 0;
      animation: fadeInUp 1s ease 0.4s forwards;
    }

    .recent-donations {
      margin-top: 20px;
      opacity: 0;
      animation: fadeInUp 1s ease 0.6s forwards;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .donation-item {
      background: rgba(0,0,0,0.7);
      border-radius: 15px;
      padding: 8px 15px;
      margin: 5px 0;
      color: var(--fg);
      font-size: 14px;
      /* Removed backdrop-filter: blur() for performance */
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideInRight 0.5s ease;
      text-align: center;
      display: inline-block;
      max-width: 90%;
      box-sizing: border-box;
      will-change: transform, opacity;
      transform: translateZ(0);
    }

    .donation-amount {
      color: var(--bar);
      font-weight: 700;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .progress-container.new-donation {
      animation: pulse 0.6s ease;
    }

    /* Goal Completion Celebration */
    @keyframes goalCompleteShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }

    @keyframes goalCompleteGlow {
      0%, 100% {
        box-shadow: 0 0 10px var(--bar);
      }
      50% {
        box-shadow: 0 0 20px var(--bar);
      }
    }

    @keyframes confetti {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      25% {
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 1;
      }
    }

    @keyframes celebration {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.1) rotate(-5deg); }
      50% { transform: scale(1.2) rotate(5deg); }
      75% { transform: scale(1.1) rotate(-3deg); }
    }

    .goal-completed {
      animation: goalCompleteShake 0.8s ease-in-out, goalCompleteGlow 2s ease-in-out infinite;
    }

    .celebration-text {
      animation: celebration 1s ease-in-out 3;
      color: #ffd700 !important;
      text-shadow: 0 0 15px #ffd700;
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      animation: confetti 3s linear forwards;
      will-change: transform;
    }

    .confetti:nth-child(odd) {
      background: #ff6b6b;
      border-radius: 50%;
    }

    .confetti:nth-child(even) {
      background: #4ecdc4;
      transform: rotate(45deg);
    }

    .confetti:nth-child(3n) {
      background: #45b7d1;
      border-radius: 50%;
    }

    .confetti:nth-child(4n) {
      background: #f9ca24;
    }

    .confetti:nth-child(5n) {
      background: #6c5ce7;
      border-radius: 50%;
    }

    /* CSS Variables with defaults */
    :root {
      --fg: #ffffff;
      --bg: #1a1a1a;
      --bar: #46e65a;
      --bar-light: #5ef56d;
    }

    /* Donation Alert Popup */
    .donation-alert {
      position: absolute;
      top: 170px;
      left: 50%;
      right: auto;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 25px 35px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(255, 71, 87, 0.5);
      font-family: 'Segoe UI', system-ui, sans-serif;
      z-index: 1000;
      transform: translateX(-50%) translateY(-50px) scale(0.8);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
      border: 2px solid rgba(255, 255, 255, 0.5);
      /* Removed backdrop-filter for performance */
      min-width: 300px;
      max-width: 90%;
      text-align: center;
      visibility: hidden;
      margin: 0;
      will-change: transform, opacity;
    }

    .donation-alert.show {
      transform: translateX(-50%) translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
      visibility: visible;
    }

    .donation-alert.hide {
      transform: translateX(-50%) translateY(-50px) scale(0.8);
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .alert-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.9);
    }

    .alert-donor {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 5px;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .alert-amount {
      font-size: 36px;
      font-weight: 900;
      color: #fff200;
      text-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(255, 242, 0, 0.5);
      margin-bottom: 8px;
    }

    .alert-user-message {
      font-size: 28px;
      color: rgba(255, 255, 255, 0.95);
      font-weight: 600;
      margin: 10px 0 8px 0;
      line-height: 1.3;
      max-width: 100%;
      word-wrap: break-word;
    }

    .alert-message {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    @keyframes alertPulse {
      0%, 100% {
        transform: translateX(-50%) scale(1);
      }
      50% {
        transform: translateX(-50%) scale(1.02);
      }
    }

    .donation-alert.pulse {
      animation: alertPulse 0.6s ease-in-out;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      #wrap { width: 100%; padding: 15px; }
      .title { font-size: 24px; }
      .progress-wrapper { gap: 10px; }
      .percentage-circle { 
        width: 60px; 
        height: 60px;
        border: 3px solid rgba(255, 255, 255, 0.2);
      }
      .percentage { font-size: 16px; }
      .progress-container { height: 45px; }
      .amount-info { font-size: 16px; }
      
      .donation-alert {
        top: 10px;
        left: 50vw;
        right: auto;
        min-width: auto;
        padding: 20px;
        max-width: calc(100vw - 40px);
      }
      
      body {
        padding-top: 20px;
      }
      
      .alert-donor { font-size: 24px; }
      .alert-amount { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="title" id="title">Loading...</div>
    <div class="progress-wrapper">
      <div class="percentage-circle" id="percentageCircle">
        <div class="liquid-fill" id="liquidFill"></div>
        <span class="percentage" id="percentage">0%</span>
      </div>
      <div class="progress-container" id="progressContainer">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    <div class="amount-info" id="amountInfo">NT$ 0 / NT$ 0</div>
    <div class="recent-donations" id="recentDonations"></div>
  </div>

  <!-- Donation Alert Popup -->
  <div class="donation-alert" id="donationAlert">
    <div class="alert-header">ÊÑüË¨ùÊñóÂÖßÔºÅ</div>
    <div class="alert-donor" id="alertDonor">Anonymous</div>
    <div class="alert-amount" id="alertAmount">NT$ 100</div>
    <div class="alert-user-message" id="alertUserMessage"></div>
    <div class="alert-message">ÊÑüË¨ùÊÇ®ÁöÑÊîØÊåÅÔºÅüíñ</div>
  </div>

  <!-- Audio for donation sound -->
  <audio id="donationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFAlGn+DyvWMeB0CU3fPPfS8GJXzJ8+GSRQ4PVafh82YYDE2n3fDGgSEQRH7H8+KVQA0PU6Xd8W+YDA9XqOzm4F8kF1efxOTts2hCKUF+vOPz6pNhIzVpqdvo2YnU3T0ZNbc6ZmJJMEZaVGZbOGVGT1BJWzu" type="audio/wav">
  </audio>

  <!-- Audio for goal completion celebration -->
  <audio id="goalCompleteSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRvIBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFAlGn+DyvWMeB0CU3fPPfS8GJXzJ8+GSRQ4PVafh82YYDE2n3fDGgSEQRH7H8+KVQA0PU6Xd8W+YDA9XqOzm4F8kF1efxOTts2hCKUF+vOPz6pNhIzVpqdvo2YnU3T0ZNbc6ZmJJMEc=" type="audio/wav">
  </audio>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <script>
    // Global settings object
    let overlaySettings = {
      fontSize: 16,
      fontColor: '#ffffff',
      backgroundColor: '#1a1a1a',
      progressBarColor: '#46e65a',
      progressBarHeight: 30,
      progressBarCornerRadius: 15,
      alertDuration: 5000,
      position: 'top-center',
      width: 900,
      alertEnabled: true,
      alertSound: true
    };

    // Extract workspace slug from URL path (/overlay/:slug)
    function getWorkspaceSlug() {
      const path = window.location.pathname;
      const match = path.match(/^\/overlay\/([^\/]+)$/);
      return match ? match[1] : null; // null means use default workspace
    }

    const workspaceSlug = getWorkspaceSlug();
    console.log('üéØ Workspace slug:', workspaceSlug || 'default');

    // Load overlay settings from server
    async function loadOverlaySettings() {
      try {
        const url = workspaceSlug 
          ? `/overlay-settings?slug=${workspaceSlug}` 
          : '/overlay-settings';
        const response = await fetch(url);
        const settings = await response.json();
        overlaySettings = { ...overlaySettings, ...settings };
        applySettings();
      } catch (error) {
        console.error('Failed to load overlay settings:', error);
        // Use defaults if loading fails
        applySettings();
      }
    }

    // Apply settings to the overlay
    function applySettings() {
      // Apply CSS custom properties
      document.documentElement.style.setProperty('--fg', overlaySettings.fontColor);
      document.documentElement.style.setProperty('--bg', overlaySettings.backgroundColor);
      document.documentElement.style.setProperty('--bar', overlaySettings.progressBarColor);
      document.documentElement.style.setProperty('--bar-light', overlaySettings.progressBarColor);

      // Apply position styling
      const wrap = document.getElementById('wrap');
      const body = document.body;
      
      // Reset positioning classes
      body.className = '';
      
      // Apply position-specific styling
      switch(overlaySettings.position) {
        case 'top-left':
          body.style.justifyContent = 'flex-start';
          body.style.alignItems = 'flex-start';
          body.style.paddingTop = '20px';
          body.style.paddingLeft = '20px';
          break;
        case 'top-center':
          body.style.justifyContent = 'center';
          body.style.alignItems = 'flex-start';
          body.style.paddingTop = '50px';
          body.style.paddingLeft = '0';
          break;
        case 'top-right':
          body.style.justifyContent = 'flex-end';
          body.style.alignItems = 'flex-start';
          body.style.paddingTop = '20px';
          body.style.paddingRight = '20px';
          break;
        case 'center':
          body.style.justifyContent = 'center';
          body.style.alignItems = 'center';
          body.style.paddingTop = '0';
          break;
        case 'bottom-left':
          body.style.justifyContent = 'flex-start';
          body.style.alignItems = 'flex-end';
          body.style.paddingBottom = '20px';
          body.style.paddingLeft = '20px';
          break;
        case 'bottom-center':
          body.style.justifyContent = 'center';
          body.style.alignItems = 'flex-end';
          body.style.paddingBottom = '50px';
          break;
        case 'bottom-right':
          body.style.justifyContent = 'flex-end';
          body.style.alignItems = 'flex-end';
          body.style.paddingBottom = '20px';
          body.style.paddingRight = '20px';
          break;
      }
      
      // Apply width
      if (wrap) {
        wrap.style.width = `${overlaySettings.width}px`;
      }
      
      // Apply font size to title
      const title = document.getElementById('title');
      if (title) {
        title.style.fontSize = `${Math.max(overlaySettings.fontSize * 2, 24)}px`;
      }
      
      // Apply progress bar height and corner radius
      const progressContainer = document.getElementById('progressContainer');
      if (progressContainer) {
        progressContainer.style.height = `${overlaySettings.progressBarHeight}px`;
        progressContainer.style.borderRadius = `${overlaySettings.progressBarCornerRadius}px`;
      }
    }

    // Elements
    const titleEl = document.getElementById('title');
    const progressFillEl = document.getElementById('progressFill');
    const percentageEl = document.getElementById('percentage');
    const percentageCircleEl = document.getElementById('percentageCircle');
    const liquidFillEl = document.getElementById('liquidFill');
    const amountInfoEl = document.getElementById('amountInfo');
    const recentDonationsEl = document.getElementById('recentDonations');
    const progressContainerEl = document.getElementById('progressContainer');

    let lastTotal = 0;
    let alertQueue = [];
    let isShowingAlert = false;
    let currentGoal = 1000; // Default goal amount
    
    // New tracking variables for reliable donation detection
    let initialized = false;
    let lastSeenTradeNo = null;
    let goalCompleted = false;
    let celebrationPlayed = false;

    // Exponential money-time mapping function (3-15 seconds)
    function calculateAlertDuration(amount) {
      // Normalize amount to 0-1 range based on current goal
      const normalizedAmount = Math.min(amount / currentGoal, 1);
      // Exponential curve: 3 + 12 * (normalized^2)
      const duration = 3000 + (12000 * Math.pow(normalizedAmount, 2));
      return Math.max(3000, Math.min(15000, duration));
    }

    // Audio warm-up for browser autoplay restrictions
    document.body.addEventListener('click', () => {
      const donationAudio = document.getElementById('donationSound');
      const goalAudio = document.getElementById('goalCompleteSound');
      donationAudio.muted = false;
      goalAudio.muted = false;
      donationAudio.play().then(() => donationAudio.pause()).catch(()=>{});
      goalAudio.play().then(() => goalAudio.pause()).catch(()=>{});
    }, { once: true });

    // Audio functions
    function playDonationSound() {
      try {
        const audio = document.getElementById('donationSound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed:', e));
      } catch (e) {
        console.log('Audio not available:', e);
      }
    }

    function playGoalCompleteSound() {
      try {
        const audio = document.getElementById('goalCompleteSound');
        audio.currentTime = 0;
        audio.volume = 0.8;
        audio.play().catch(e => console.log('Goal complete audio failed:', e));
      } catch (e) {
        console.log('Goal complete audio not available:', e);
      }
    }

    function showDonationAlert(donor, amount, message) {
      // Check if alerts are enabled
      if (!overlaySettings.alertEnabled) {
        return;
      }

      if (isShowingAlert) {
        // Queue the alert if one is already showing
        alertQueue.push({ donor, amount, message });
        return;
      }

      isShowingAlert = true;
      const alertEl = document.getElementById('donationAlert');
      const donorEl = document.getElementById('alertDonor');
      const amountEl = document.getElementById('alertAmount');
      const messageEl = document.getElementById('alertUserMessage');

      // Update content
      donorEl.textContent = donor || 'ÂåøÂêç';
      amountEl.textContent = `NT$ ${formatNumber(amount)}`;
      
      // Display message if it exists
      if (message && message.trim()) {
        messageEl.textContent = message;
        messageEl.style.display = 'block';
      } else {
        messageEl.textContent = '';
        messageEl.style.display = 'none';
      }

      // Play sound if enabled
      if (overlaySettings.alertSound) {
        playDonationSound();
      }

      // Force a reflow to ensure CSS is applied
      alertEl.offsetHeight;
      
      // Show alert with animation
      alertEl.classList.remove('hide');
      alertEl.classList.add('show', 'pulse');
      
      // Debug log
      console.log('Showing donation alert for:', donor, amount);

      // Use configured duration or calculate dynamic duration
      const duration =  calculateAlertDuration(amount) || overlaySettings.alertDuration;
      
      // Hide after calculated duration
      setTimeout(() => {
        alertEl.classList.remove('show', 'pulse');
        alertEl.classList.add('hide');
        
        // Reset after hide animation
        setTimeout(() => {
          isShowingAlert = false;
          
          // Show next alert in queue
          if (alertQueue.length > 0) {
            const next = alertQueue.shift();
            setTimeout(() => showDonationAlert(next.donor, next.amount, next.message), 200);
          }
        }, 500);
      }, duration);
    }

    // Goal completion celebration functions - optimized for performance
    function createConfetti() {
      const container = document.getElementById('confettiContainer');
      const confettiCount = 25; // Reduced from 50 for better performance
      
      // Clear existing confetti
      container.innerHTML = '';
      
      // Use DocumentFragment for batch DOM insertion
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.animationDuration = (Math.random() * 1.5 + 2) + 's';
        fragment.appendChild(confetti);
      }
      container.appendChild(fragment);
      
      // Remove confetti after animation
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    function celebrateGoalComplete(goalTitle) {
      if (celebrationPlayed) return;
      
      celebrationPlayed = true;
      console.log('üéâ Goal completed! Starting celebration...');
      
      // Play celebration sound
      playGoalCompleteSound();
      
      // Create confetti animation
      createConfetti();
      
      // Add celebration classes
      progressContainerEl.classList.add('goal-completed');
      titleEl.classList.add('celebration-text');
      
      // Change title text using the actual goal title
      titleEl.textContent = 'üéâ ' + (goalTitle || 'ÊàëÊÑõjjmow') + ' üéâ';
      
      // Optional: Remove celebration effects after some time
      setTimeout(() => {
        progressContainerEl.classList.remove('goal-completed');
        // Keep celebration text for longer visibility
      }, 5000);
    }

    function formatNumber(num) {
      return (num || 0).toLocaleString('zh-TW');
    }

    // Calculate donation amount color intensity (more money = more red)
    function getDonationAmountColor(amount) {
      // Normalize amount to 0-1 range based on half the current goal (for better color scaling)
      const normalizedAmount = Math.min(amount / (currentGoal * 0.5), 1);
      // Create red intensity gradient
      const redIntensity = Math.floor(100 + (155 * normalizedAmount)); // 100-255 range
      const green = Math.max(0, 100 - (100 * normalizedAmount)); // Decrease green as amount increases
      const blue = Math.max(0, 100 - (100 * normalizedAmount)); // Decrease blue as amount increases
      return `rgb(${redIntensity}, ${green}, ${blue})`;
    }


    function renderProgress(data) {
      const { title, current, goal, percent, donations, actualDonations, startFrom } = data;
      console.log('üìä Rendering progress:', { current, goal, percent, donationCount: donations?.length || 0, lastTotal });
      
      // Update current goal for normalization calculations
      if (goal) {
        currentGoal = goal;
      }
      
      // Check for goal completion
      const isGoalComplete = percent >= 100;
      if (isGoalComplete && !goalCompleted) {
        goalCompleted = true;
        celebrateGoalComplete(title);
      } else if (!isGoalComplete && goalCompleted) {
        // Reset if goal is no longer complete (e.g., goal amount increased)
        goalCompleted = false;
        celebrationPlayed = false;
        titleEl.classList.remove('celebration-text');
      }
      
      // Update title (only if not celebrating)
      if (!goalCompleted) {
        titleEl.textContent = title || 'ÊñóÂÖßÁõÆÊ®ô';
      }
      
      // Update progress bar with animation
      const clampedPercent = Math.min(100, Math.max(0, percent || 0));
      progressFillEl.style.width = `${clampedPercent}%`;
      percentageEl.textContent = `${clampedPercent}%`;
      
      // Update liquid fill in circle (0-100% fills the circle from bottom to top)
      if (liquidFillEl) {
        liquidFillEl.style.height = `${clampedPercent}%`;
      }
      
      // Add shimmer effect to circle on progress update
      if (percentageCircleEl && current > lastTotal && lastTotal > 0) {
        percentageCircleEl.classList.add('update');
        setTimeout(() => {
          percentageCircleEl.classList.remove('update');
        }, 600);
      }
      
      // Update amount info - show total (including startFrom) vs goal
      if (isGoalComplete) {
        amountInfoEl.innerHTML = `üéâ <strong>ÁõÆÊ®ôÈÅîÊàêÔºÅ</strong> NT$ ${formatNumber(current)} / NT$ ${formatNumber(goal)} üéâ`;
      } else {
        amountInfoEl.textContent = `NT$ ${formatNumber(current)} / NT$ ${formatNumber(goal)}`;
      }
      
      // Check for donation change (animate if total changed)
      if (current !== lastTotal && lastTotal >= 0) {
        // Animate on increase
        if (current > lastTotal) {
          progressContainerEl.classList.add('new-donation');
          progressFillEl.classList.add('animate');
          
          setTimeout(() => {
            progressContainerEl.classList.remove('new-donation');
            progressFillEl.classList.remove('animate');
          }, 600);
        }
      }
      lastTotal = current;
      
      // Check for new donations and show alerts (fixed detection)
      if (donations && donations.length) {
        // newest donation is the last item in the (last 5) list
        const newest = donations[donations.length - 1];

        if (initialized) {
          if (newest.tradeNo && newest.tradeNo !== lastSeenTradeNo) {
            // Try to show all unseen donations that are still within the last-5 window
            const startIdx = donations.findIndex(d => d.tradeNo === lastSeenTradeNo);
            const newOnes = startIdx === -1 ? [newest] : donations.slice(startIdx + 1);
            newOnes.forEach(d => showDonationAlert(d.payer, d.amount, d.message));
          }
        } else {
          // don't alert on initial load
          initialized = true;
        }

        lastSeenTradeNo = newest.tradeNo || lastSeenTradeNo;
      }
      
      // Render donations (server handles filtering based on donationDisplayMode)
      if (donations && donations.length > 0) {
        const donationHTML = donations
          .map(donation => {
            const amountColor = getDonationAmountColor(donation.amount);
            const messageHTML = donation.message && donation.message.trim() 
              ? `<div style="font-size: 13px; margin-top: 4px; opacity: 0.9;">${donation.message}</div>` 
              : '';
            return `
            <div class="donation-item">
              <div>
                <strong>${donation.payer}</strong> ÊñóÂÖß‰∫Ü 
                <span class="donation-amount" style="color: ${amountColor}; font-weight: bold;">NT$ ${formatNumber(donation.amount)}</span>ÔºÅÔºÅ
              </div>
              ${messageHTML}
            </div>
          `}).join('');
        
        recentDonationsEl.innerHTML = donationHTML;
      } else {
        // Clear UI and internal trackers when no donations to display
        recentDonationsEl.innerHTML = '';
        lastSeenTradeNo = null;     // so next donation will trigger alert
        initialized = true;         // avoids "first-load" alert
        lastTotal = current || 0;   // keep total consistent for animation check
      }
    }

    // Initial load
    async function loadInitialData() {
      try {
        const url = workspaceSlug 
          ? `/progress?slug=${workspaceSlug}` 
          : '/progress';
        const response = await fetch(url);
        const data = await response.json();
        renderProgress(data);
      } catch (error) {
        console.error('Failed to load initial data:', error);
        titleEl.textContent = 'ÈÄ£Á∑öÈåØË™§';
      }
    }

    // SSE reconnection with exponential backoff
    let sseReconnectAttempts = 0;
    const MAX_RECONNECT_DELAY = 30000; // 30 seconds max
    
    // Server-Sent Events for real-time updates
    function setupSSE() {
      const eventsUrl = workspaceSlug ? `/events?slug=${workspaceSlug}` : '/events';
      console.log('üîå Connecting to SSE:', eventsUrl);
      const eventSource = new EventSource(eventsUrl);
      
      eventSource.onopen = function() {
        console.log('‚úÖ SSE connection established');
        sseReconnectAttempts = 0; // Reset on successful connection
      };
      
      eventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('üì° SSE update received');
          renderProgress(data);
        } catch (error) {
          console.error('Error parsing SSE data:', error);
        }
      };

      // Listen for overlay settings updates
      eventSource.addEventListener('overlay-settings', function(event) {
        try {
          const newSettings = JSON.parse(event.data);
          console.log('üé® Overlay settings updated via SSE:', newSettings);
          applyOverlaySettings(newSettings);
        } catch (error) {
          console.error('Error parsing overlay settings:', error);
        }
      });
      
      eventSource.onerror = function(error) {
        console.error('‚ùå SSE connection error:', error);
        
        if (eventSource.readyState === EventSource.CLOSED) {
          // Exponential backoff: 2s, 4s, 8s, 16s, 30s (max)
          sseReconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, sseReconnectAttempts), MAX_RECONNECT_DELAY);
          console.log(`üîÅ Reconnecting in ${delay/1000}s (attempt ${sseReconnectAttempts})...`);
          
          setTimeout(() => {
            setupSSE();
          }, delay);
        }
      };
      
      return eventSource;
    }

    // Global eventSource variable for cleanup
    let eventSource = null;
    
    // Initialize
    loadOverlaySettings().then(() => {
      loadInitialData();
      eventSource = setupSSE();
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (eventSource) {
        eventSource.close();
      }
    });

    // Test mode (if ?test=1 in URL)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('test') === '1') {
      let testPercent = 0;
      setInterval(() => {
        testPercent = (testPercent + 1) % 101;
        renderProgress({
          title: 'Ê∏¨Ë©¶ÁõÆÊ®ô',
          current: testPercent * 500,
          goal: 50000,
          percent: testPercent,
          donations: [
            { payer: 'TestUser1', amount: 100, at: new Date().toISOString() },
            { payer: 'TestUser2', amount: 500, at: new Date().toISOString() }
          ],
        });
      }, 100);
    }
  </script>
</body>
</html>
