<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - Donation Goal Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Static background overlay - optimized for performance */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
      /* Removed infinite animation for performance */
      opacity: 0.8;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 42px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 10px;
    }

    .header p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 18px;
      font-weight: 500;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: rgba(27, 31, 38, 0.98);
      /* Removed backdrop-filter for performance */
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.15);
      animation: slideIn 0.4s ease-out;
      color: #1f2937;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card.full-width {
      grid-column: 1 / -1;
    }

    .card h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #46e65a;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4b5563;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 2px solid #2a2f36;
      background: #0f1216;
      color: #ffffff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #46e65a;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #46e65a, #5ef56d);
      color: #000000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(70, 230, 90, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: #ffffff;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    .btn-secondary {
      background: #2a2f36;
      color: #ffffff;
    }

    .btn-secondary:hover {
      background: #3a3f46;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-item {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #46e65a;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #a0a0a0;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #2a2f36;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #46e65a, #5ef56d);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .donations-list {
      max-height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
    }

    .donation-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 4px solid #46e65a;
    }

    .donation-info {
      flex: 1;
    }

    .donation-amount {
      font-weight: 700;
      color: #46e65a;
      font-size: 16px;
    }

    .donation-payer {
      color: #ffffff;
      margin-bottom: 2px;
    }

    .donation-time {
      font-size: 12px;
      color: #a0a0a0;
    }

    .quick-links {
      display: flex;
      gap: 0;
      flex-wrap: wrap;
      margin-bottom: 30px;
      background: rgba(27, 31, 38, 0.98);
      /* Removed backdrop-filter for performance */
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      align-items: center;
    }

    .quick-links .btn {
      border-radius: 8px;
      margin: 0 5px;
      transition: all 0.3s ease;
      font-size: 14px;
      padding: 10px 20px;
    }

    .quick-links .btn:hover {
      transform: translateY(-2px);
    }

    .quick-links .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .quick-links .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .quick-links .btn-danger {
      margin-left: auto;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
      animation: slideInDown 0.3s ease-out;
      position: relative;
      overflow: hidden;
      /* Removed backdrop-filter for performance */
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .alert::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: currentColor;
      animation: progressBar 0.3s ease-out;
    }

    .alert-success {
      background: rgba(27, 31, 38, 0.98);
      border: 2px solid #46e65a;
      color: #46e65a;
      border-left: 5px solid #46e65a;
    }

    .alert-error {
      background: rgba(27, 31, 38, 0.98);
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      border-left: 5px solid #ff6b6b;
    }

    .alert-info {
      background: rgba(27, 31, 38, 0.98);
      border: 2px solid #3498db;
      color: #3498db;
      border-left: 5px solid #3498db;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn.loading {
      position: relative;
      color: transparent;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .btn.loading.btn-primary::after {
      border-top-color: #000000;
    }

    .btn.loading.btn-danger::after {
      border-top-color: #ffffff;
    }

    .form-feedback {
      margin-top: 5px;
      font-size: 12px;
      min-height: 16px;
    }

    .form-feedback.success {
      color: #46e65a;
    }

    .form-feedback.error {
      color: #ff6b6b;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes progressBar {
      from {
        left: -100%;
      }

      to {
        left: 100%;
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Subscription Status Styles */
    .subscription-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subscription-badge.free {
      background: rgba(160, 160, 160, 0.2);
      color: #a0a0a0;
      border: 1px solid #a0a0a0;
    }

    .subscription-badge.free_pass {
      background: rgba(138, 43, 226, 0.2);
      color: #BA55D3;
      border: 1px solid #BA55D3;
    }

    .subscription-badge.trial {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid #3498db;
    }

    .subscription-badge.basic,
    .subscription-badge.pro,
    .subscription-badge.enterprise {
      background: rgba(70, 230, 90, 0.2);
      color: #46e65a;
      border: 1px solid #46e65a;
    }

    .subscription-badge.expired,
    .subscription-badge.canceled {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid #ff6b6b;
    }

    .trial-warning {
      background: rgba(255, 165, 0, 0.1);
      border-left: 4px solid #FFA500;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      color: #FFA500;
    }

    .trial-warning.urgent {
      background: rgba(255, 107, 107, 0.1);
      border-left-color: #ff6b6b;
      color: #ff6b6b;
    }

    .plan-features {
      list-style: none;
      margin: 15px 0;
    }

    .plan-features li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      color: #e0e0e0;
    }

    .plan-features li::before {
      content: 'âœ“';
      color: #46e65a;
      font-weight: bold;
      margin-right: 10px;
      font-size: 16px;
    }

    .plan-features li.disabled::before {
      content: 'âœ—';
      color: #666;
    }

    .plan-features li.disabled {
      color: #666;
      text-decoration: line-through;
    }

    .feedback-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(70, 230, 90, 0.1);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #46e65a, #5ef56d);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #000;
    }

    .user-details h3 {
      margin: 0;
      font-size: 18px;
      color: #fff;
    }

    .user-details p {
      margin: 5px 0 0 0;
      font-size: 13px;
      color: #a0a0a0;
    }

    @keyframes pulse-success {
      0% {
        box-shadow: 0 0 0 0 rgba(70, 230, 90, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(70, 230, 90, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(70, 230, 90, 0);
      }
    }

    @keyframes pulse-error {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
      }
    }

    .pulse-success {
      animation: pulse-success 0.6s;
    }

    .pulse-error {
      animation: pulse-error 0.6s;
    }

    /* Modal Overlay Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      /* Removed backdrop-filter for performance */
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: rgba(27, 31, 38, 0.98);
      border-radius: 20px;
      padding: 30px;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      animation: slideUp 0.3s ease;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 107, 107, 0.2);
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #ff6b6b;
      color: #ffffff;
      transform: rotate(90deg);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }

      .quick-links {
        flex-direction: column;
        gap: 5px;
        padding: 8px;
      }

      .quick-links .btn {
        width: 100%;
        margin: 3px 0;
      }

      .quick-links .btn-danger {
        margin-left: 0;
      }

      .btn {
        width: 100%;
      }

      .modal-content {
        padding: 20px;
        max-height: 85vh;
      }
    }

    /* Webhook Notification Styles */
    .webhook-notification {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideInDown 0.3s ease-out;
      border-left: 4px solid;
    }

    .webhook-notification.warning {
      background: rgba(255, 193, 7, 0.15);
      border-left-color: #ffc107;
      color: #ffc107;
    }

    .webhook-notification.error {
      background: rgba(255, 107, 107, 0.15);
      border-left-color: #ff6b6b;
      color: #ff6b6b;
    }

    .webhook-notification.info {
      background: rgba(52, 152, 219, 0.15);
      border-left-color: #3498db;
      color: #3498db;
    }

    .webhook-notification .icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .webhook-notification .content {
      flex: 1;
    }

    .webhook-notification .message {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .webhook-notification .details {
      font-size: 12px;
      opacity: 0.85;
      font-family: monospace;
      background: rgba(0, 0, 0, 0.2);
      padding: 6px 10px;
      border-radius: 5px;
      margin-top: 6px;
      white-space: pre-wrap;
    }

    .webhook-notification .time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .webhook-notification .close-btn {
      background: none;
      border: none;
      color: inherit;
      opacity: 0.6;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      line-height: 1;
    }

    .webhook-notification .close-btn:hover {
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Admin Panel</h1>
      <p>ç®¡ç†ææ¬¾ç›®æ¨™å’Œç›£æ§ç›´æ’­é€²åº¦</p>
    </div>

    <div class="quick-links">
      <a href="/overlay" class="btn btn-secondary" target="_blank">ğŸ“Š æŸ¥çœ‹æ–—å…§æ¢</a>
      <button class="btn btn-secondary" onclick="toggleDonationMethodsModal()">ğŸ’° ææ¬¾æ–¹å¼</button>
      <button class="btn btn-secondary" onclick="toggleSubscriptionModal()">ğŸ’ è¨‚é–±æ–¹æ¡ˆ</button>
      <button class="btn btn-secondary" onclick="toggleFeedbackModal()">ğŸ’¬ æ„è¦‹å›é¥‹</button>
      <button class="btn btn-secondary" onclick="window.location.reload()">ğŸ”„ é‡æ–°æ•´ç†</button>
      <button class="btn btn-danger" onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <div id="alertContainer"></div>

    <!-- User Info & Subscription Status -->
    <div class="card" style="margin-bottom: 30px;">
      <div class="user-info" id="userInfo">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-details">
          <h3 id="userName">Loading...</h3>
          <p id="userEmail">Loading...</p>
        </div>
        <div style="margin-left: auto;">
          <span class="subscription-badge" id="subscriptionBadge" style="color: white;">Loading...</span>
        </div>
      </div>

      <div id="subscriptionStatus">
        <!-- Subscription details will be loaded here -->
      </div>
    </div>

    <div class="dashboard">
      <!-- Current Progress -->
      <div class="card">
        <h2>ç•¶å‰é€²åº¦</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="currentTotal">NT$ 0</div>
            <div class="stat-label">å·²å‹Ÿé›†é‡‘é¡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="progressPercent">0%</div>
            <div class="stat-label">å®Œæˆåº¦</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="donationCount">0</div>
            <div class="stat-label">ææ¬¾æ¬¡æ•¸</div>
          </div>
        </div>

        <div>
          <strong id="goalTitle">Loading...</strong>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div style="text-align: center; color: #a0a0a0;">
            NT$ <span id="remainingAmount">0</span> é‚„éœ€è¦é”æˆç›®æ¨™
          </div>
        </div>
      </div>

      <!-- Goal Settings -->
      <div class="card">
        <h2>ç›®æ¨™è¨­å®š</h2>
        <form id="goalForm">
          <div class="form-group">
            <label for="goalTitleInput">ç›®æ¨™æ¨™é¡Œ</label>
            <input type="text" id="goalTitleInput" placeholder="ä¾‹ï¼šGaming PC Goal" required>
          </div>

          <div class="form-group">
            <label for="goalAmountInput">ç›®æ¨™é‡‘é¡ (NT$)</label>
            <input type="number" id="goalAmountInput" min="1" placeholder="50000" required>
          </div>

          <div class="form-group">
            <label for="goalStartFromInput">èµ·å§‹é‡‘é¡ (NT$)</label>
            <input type="number" id="goalStartFromInput" min="0" value="0" placeholder="0">
            <div
              style="background: #ff6b6b; color: white; padding: 10px; border-radius: 5px; margin-top: 8px; font-size: 12px; line-height: 1.4;">
              âš ï¸ <strong>é“å¾·æé†’ï¼š</strong>è¨­å®šèµ·å§‹é‡‘é¡å¯èƒ½æœƒèª¤å°è§€çœ¾ï¼Œè®“ä»–å€‘ä»¥ç‚ºæ‚¨å·²ç¶“æ”¶åˆ°æ›´å¤šææ¬¾ã€‚è«‹è¬¹æ…ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œä¸¦è€ƒæ…®é€æ˜åº¦å°æ–¼å»ºç«‹è§€çœ¾ä¿¡ä»»çš„é‡è¦æ€§ã€‚
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="goalSubmitBtn">ğŸ’¾ æ›´æ–°ç›®æ¨™</button>
          <div class="form-feedback" id="goalFeedback"></div>
        </form>
      </div>

      <!-- Recent Donations -->
      <div class="card">
        <h2>æœ€è¿‘ææ¬¾</h2>
        <div class="donations-list" id="donationsList">
          <div style="text-align: center; color: #a0a0a0; padding: 20px;">
            è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <!-- ECPay Configuration -->
      <div class="card">
        <h2>ECPay é‡‘æµè¨­å®š</h2>
        <div class="alert alert-info"
          style="background-color: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
          <strong>âš ï¸ é‡è¦æé†’ï¼š</strong> ç„¡è«–æ‚¨æƒ³ä½¿ç”¨å“ªç¨®æ–—å…§æ–¹å¼ï¼Œéƒ½<strong>å¿…é ˆ</strong>æ­£ç¢ºè¨­å®šä»¥ä¸‹ ECPay é‡‘æµè³‡æ–™ï¼Œè§€çœ¾çš„æ–—å…§æ‰èƒ½æˆåŠŸè™•ç†ï¼
          <br><small style="color: #666; margin-top: 8px; display: block;">è«‹è‡³ ECPay å•†åº—å¾Œå°å–å¾—é€™äº›è³‡æ–™ã€‚</small>
        </div>
        <form id="ecpayForm">
          <div class="form-group">
            <label for="merchantIdInput">å•†åº—ä»£è™Ÿ (MerchantID)</label>
            <input type="text" id="merchantIdInput" placeholder="è«‹è¼¸å…¥ ECPay å•†åº—ä»£è™Ÿ" required>
          </div>

          <div class="form-group">
            <label for="hashKeyInput">HashKey</label>
            <input type="password" id="hashKeyInput" placeholder="è«‹è¼¸å…¥ ECPay HashKey">
          </div>

          <div class="form-group">
            <label for="hashIVInput">HashIV</label>
            <input type="password" id="hashIVInput" placeholder="è«‹è¼¸å…¥ ECPay HashIV">
          </div>

          <button type="submit" class="btn btn-primary" id="ecpaySubmitBtn">ğŸ’¾ æ›´æ–° ECPay è¨­å®š</button>
          <div class="form-feedback" id="ecpayFeedback"></div>
        </form>
      </div>


      <!-- Overlay Settings -->
      <div class="card">
        <h2>æ–—å…§æ¢å¤–è§€è¨­å®š</h2>
        <form id="overlaySettingsForm">
          <div class="form-group">
            <label>
              <input type="checkbox" id="alertEnabledInput"> å•Ÿç”¨ææ¬¾æé†’å½ˆçª—
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="alertSoundInput"> æ’­æ”¾ææ¬¾éŸ³æ•ˆ
            </label>
          </div>

          <div class="form-group">
            <label for="fontSizeInput">å­—é«”å¤§å° (px)</label>
            <input type="number" id="fontSizeInput" min="10" max="50" value="16">
          </div>

          <div class="form-group">
            <label for="fontColorInput">å­—é«”é¡è‰²</label>
            <input type="color" id="fontColorInput" value="#ffffff">
          </div>

          <div class="form-group">
            <label for="backgroundColorInput">èƒŒæ™¯é¡è‰²</label>
            <input type="color" id="backgroundColorInput" value="#1a1a1a">
          </div>

          <div class="form-group">
            <label for="progressBarColorInput">é€²åº¦æ¢é¡è‰²</label>
            <input type="color" id="progressBarColorInput" value="#46e65a">
          </div>

          <div class="form-group">
            <label for="progressBarHeightInput">é€²åº¦æ¢é«˜åº¦ (px)</label>
            <input type="number" id="progressBarHeightInput" min="10" max="100" value="30">
          </div>

          <div class="form-group">
            <label for="progressBarCornerRadiusInput">é€²åº¦æ¢åœ“è§’ (px)</label>
            <input type="number" id="progressBarCornerRadiusInput" min="0" max="50" value="15">
          </div>

          <div class="form-group">
            <label for="positionInput">ä½ç½®</label>
            <select id="positionInput">
              <option value="top-left">å·¦ä¸Š</option>
              <option value="top-center" selected>æ­£ä¸Š</option>
              <option value="top-right">å³ä¸Š</option>
              <option value="center">ä¸­å¤®</option>
              <option value="bottom-left">å·¦ä¸‹</option>
              <option value="bottom-center">æ­£ä¸‹</option>
              <option value="bottom-right">å³ä¸‹</option>
            </select>
          </div>

          <div class="form-group">
            <label for="widthInput">å¯¬åº¦ (px)</label>
            <input type="number" id="widthInput" min="300" max="1920" value="900">
          </div>

          <div class="form-group">
            <label for="alertDurationInput">æé†’é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’)</label>
            <input type="number" id="alertDurationInput" min="1000" max="30000" value="5000">
          </div>

          <div class="form-group">
            <label for="donationDisplayModeInput">é€²åº¦æ¢ä¸‹æ–¹ææ¬¾é¡¯ç¤ºæ¨¡å¼</label>
            <select id="donationDisplayModeInput"
              style="width: 100%; padding: 12px 15px; border-radius: 8px; border: 2px solid #2a2f36; background: #0f1216; color: #ffffff; font-size: 14px;">
              <option value="top">é¡¯ç¤ºé‡‘é¡å‰ N å (å¾é«˜åˆ°ä½)</option>
              <option value="latest">é¡¯ç¤ºæœ€è¿‘ N ç­† (å¾æ–°åˆ°èˆŠ)</option>
              <option value="hidden">ä¸é¡¯ç¤º</option>
            </select>
            <div style="font-size: 12px; color: #a0a0a0; margin-top: 8px;">
              ğŸ’¡ æ§åˆ¶é€²åº¦æ¢ä¸‹æ–¹é¡¯ç¤ºå“ªäº›ææ¬¾è¨˜éŒ„
            </div>
          </div>

          <div class="form-group">
            <label for="donationDisplayCountInput">é¡¯ç¤ºææ¬¾æ•¸é‡ (N)</label>
            <input type="number" id="donationDisplayCountInput" min="1" max="10" value="3">
            <div style="font-size: 12px; color: #a0a0a0; margin-top: 8px;">
              ğŸ’¡ è¨­å®šè¦é¡¯ç¤ºå¹¾ç­†ææ¬¾è¨˜éŒ„ (1-10)
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="overlaySubmitBtn">ğŸ’¾ æ›´æ–°æ–—å…§æ¢è¨­å®š</button>
          <div class="form-feedback" id="overlayFeedback"></div>
        </form>
      </div>

      <!-- Admin Actions -->
      <div class="card">
        <h2>ç®¡ç†æ“ä½œ</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <button class="btn btn-danger" onclick="resetProgress()">
            ğŸ—‘ï¸ é‡ç½®é€²åº¦ (æ¸…ç©ºæ‰€æœ‰ææ¬¾è¨˜éŒ„)
          </button>

          <div style="margin-top: 20px;">
            <h3 style="margin-bottom: 15px; color: #e0e0e0;">OBS è¨­å®š</h3>
            <p style="color: #a0a0a0; margin-bottom: 10px;">
              åœ¨ OBS ä¸­æ·»åŠ  Browser Sourceï¼Œä½¿ç”¨ä»¥ä¸‹ URLï¼š
            </p>
            <div style="background: #0f1216; padding: 15px; border-radius: 8px; border: 1px solid #2a2f36;">
              <code id="obsUrl" style="color: #454e46; word-break: break-all;"></code>
            </div>
            <p style="color: #a0a0a0; margin-top: 10px; font-size: 14px;">
              å»ºè­°å°ºå¯¸ï¼š900 x 150 pixelsï¼Œå•Ÿç”¨é€æ˜èƒŒæ™¯
            </p>
          </div>
        </div>
      </div>

      <!-- Overlay Preview -->
      <div class="card full-width">
        <h2>ğŸ¥ æ–—å…§æ¢å³æ™‚é è¦½</h2>
        <p style="color: #a0a0a0; margin-bottom: 15px;">
          ä»¥ä¸‹æ˜¯æ‚¨çš„æ–—å…§æ¢å³æ™‚é è¦½ã€‚èª¿æ•´è¨­å®šå¾Œæœƒè‡ªå‹•åæ˜ åœ¨æ­¤é è¦½ä¸­ã€‚
        </p>
        <div
          style="background: #000; border-radius: 8px; overflow: hidden; border: 2px solid #2a2f36; position: relative;">
          <div
            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; font-size: 12px; color: #4CAF50; z-index: 10;">
            â— LIVE
          </div>
          <iframe id="overlayPreview" src="about:blank"
            style="width: 100%; height: 400px; border: none; display: block; background: #1a1a1a;"
            title="Overlay Preview">
          </iframe>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn" onclick="refreshOverlayPreview()" style="background: #2196F3;">
            ğŸ”„ é‡æ–°æ•´ç†é è¦½
          </button>
          <button class="btn" onclick="togglePreviewSize()" style="background: #9C27B0;">
            ğŸ“ åˆ‡æ›é è¦½å¤§å°
          </button>
          <button class="btn" onclick="window.open(workspaceUrls.overlay, '_blank')" style="background: #4CAF50;">
            ğŸš€ åœ¨æ–°åˆ†é é–‹å•Ÿ
          </button>
        </div>
        <p style="color: #666; margin-top: 10px; font-size: 13px;">
          ğŸ’¡ æç¤ºï¼šé è¦½æœƒå³æ™‚é¡¯ç¤ºæ–—å…§é€²åº¦å’Œå¤–è§€è®ŠåŒ–ã€‚èª¿æ•´æ–—å…§æ¢è¨­å®šå¾Œæœƒè‡ªå‹•æ›´æ–°ã€‚
        </p>
      </div>

    </div>

    <!-- Subscription Management Modal -->
    <div id="subscriptionModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" onclick="toggleSubscriptionModal()">Ã—</button>

        <h2 style="margin-bottom: 10px;">ğŸ’ è¨‚é–±æ–¹æ¡ˆç®¡ç†</h2>
        <div id="subscriptionManagement">
          <!-- Subscription management content will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" onclick="toggleFeedbackModal()">Ã—</button>

        <h2 style="margin-bottom: 10px;">ğŸ’¬ æ„è¦‹å›é¥‹</h2>
        <p style="color: #a0a0a0; margin-bottom: 20px;">
          æœ‰ä»»ä½•å»ºè­°æˆ–å•é¡Œå—ï¼Ÿæˆ‘å€‘å¾ˆæ¨‚æ„è½å–æ‚¨çš„æ„è¦‹ï¼
        </p>
        <form id="feedbackForm">
          <div class="form-group">
            <label for="feedbackType">å›é¥‹é¡å‹</label>
            <select id="feedbackType"
              style="width: 100%; padding: 12px 15px; border-radius: 8px; border: 2px solid #2a2f36; background: #0f1216; color: #ffffff; font-size: 14px;">
              <option value="bug">ğŸ› Bug å›å ±</option>
              <option value="feature">âœ¨ åŠŸèƒ½å»ºè­°</option>
              <option value="improvement">ğŸš€ æ”¹å–„å»ºè­°</option>
              <option value="question">â“ å•é¡Œè©¢å•</option>
              <option value="other">ğŸ’­ å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label for="feedbackMessage">è©³ç´°èªªæ˜</label>
            <textarea id="feedbackMessage" class="feedback-textarea" placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„æ„è¦‹æˆ–å•é¡Œ..." required></textarea>
          </div>

          <button type="submit" class="btn btn-primary" id="feedbackSubmitBtn">
            ğŸ“¤ æäº¤å›é¥‹
          </button>
          <div class="form-feedback" id="feedbackFeedback"></div>
        </form>
      </div>
    </div>

    <!-- Donation Methods Modal -->
    <div id="donationMethodsModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" onclick="toggleDonationMethodsModal()">Ã—</button>

        <h2 style="margin-bottom: 10px;">ğŸ’° æ¥å—ææ¬¾çš„æ–¹å¼</h2>
        <p style="color: #a0a0a0; margin-bottom: 20px;">
          æ‚¨å¯ä»¥é¸æ“‡ä»¥ä¸‹å…©ç¨®æ–¹å¼ä¾†æ¥å—è§€çœ¾çš„ææ¬¾ï¼š
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
          <!-- Method 1: Donate Page -->
          <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; border: 2px solid #2a2f36;">
            <h3 style="color: #46e65a; margin-bottom: 15px;">ğŸ“„ æ–¹æ³•ä¸€ï¼šä½¿ç”¨ææ¬¾é é¢</h3>
            <p style="color: #e0e0e0; margin-bottom: 15px; line-height: 1.6;">
              é€éæˆ‘å€‘çš„ææ¬¾é é¢ï¼Œè§€çœ¾å¯ä»¥ç›´æ¥è¼¸å…¥é‡‘é¡å’Œç•™è¨€ï¼Œç³»çµ±æœƒè‡ªå‹•å°å‘ ECPay ä»˜æ¬¾é é¢ã€‚ä»˜æ¬¾å®Œæˆå¾Œæœƒè‡ªå‹•æ›´æ–°é€²åº¦æ¢ã€‚
            </p>
            <div
              style="background: #0f1216; padding: 12px; border-radius: 8px; border: 1px solid #2a2f36; margin-bottom: 15px;">
              <div style="color: #808080; font-size: 12px; margin-bottom: 5px;">ææ¬¾é é¢ç¶²å€ï¼š</div>
              <code id="donatePageUrl" style="color: #46e65a; word-break: break-all; font-size: 13px;"></code>
            </div>
            <button class="btn btn-secondary"
              onclick="copyToClipboard(document.getElementById('donatePageUrl').textContent, 'ææ¬¾é é¢ç¶²å€å·²è¤‡è£½')">
              ğŸ“‹ è¤‡è£½ç¶²å€
            </button>
            <a href="/donate" class="btn" target="_blank" style="background: #3498db; margin-left: 10px;">
              ğŸ‘ï¸ æŸ¥çœ‹é é¢
            </a>
          </div>

          <!-- Method 2: Webhook -->
          <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; border: 2px solid #2a2f36;">
            <h3 style="color: #46e65a; margin-bottom: 15px;">ğŸ”— æ–¹æ³•äºŒï¼šECPay Webhook</h3>
            <p style="color: #e0e0e0; margin-bottom: 15px; line-height: 1.6;">
              å¦‚æœæ‚¨å·²ç¶“æœ‰è‡ªå·±çš„å•†åº—æˆ–ææ¬¾æ–¹å¼ï¼Œå¯ä»¥åœ¨ ECPay å•†åº—å¾Œå°è¨­å®š Webhookï¼Œè®“ç³»çµ±è‡ªå‹•æ¥æ”¶ä»˜æ¬¾é€šçŸ¥ä¸¦æ›´æ–°é€²åº¦æ¢ã€‚
            </p>
            <div
              style="background: #0f1216; padding: 12px; border-radius: 8px; border: 1px solid #2a2f36; margin-bottom: 15px;">
              <div style="color: #808080; font-size: 12px; margin-bottom: 5px;">Webhook ç¶²å€ï¼š</div>
              <code id="webhookUrl" style="color: #46e65a; word-break: break-all; font-size: 13px;"></code>
            </div>
            <button class="btn btn-secondary"
              onclick="copyToClipboard(document.getElementById('webhookUrl').textContent, 'Webhook ç¶²å€å·²è¤‡è£½')">
              ğŸ“‹ è¤‡è£½ç¶²å€
            </button>
            <div
              style="margin-top: 15px; padding: 12px; background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 8px;">
              <div style="font-size: 13px; color: #3498db; margin-bottom: 8px;">âš™ï¸ ECPay è¨­å®šæ­¥é©Ÿï¼š</div>
              <ol style="color: #a0a0a0; font-size: 13px; margin-left: 20px; line-height: 1.8;">
                <li>ç™»å…¥ ECPay å•†åº—å¾Œå°</li>
                <li>æ‰¾åˆ°ã€Œä»˜æ¬¾å®Œæˆé€šçŸ¥å›å‚³ç¶²å€ã€è¨­å®š</li>
                <li>è²¼ä¸Šä¸Šæ–¹çš„ Webhook ç¶²å€</li>
                <li>ç¢ºä¿ä½¿ç”¨ <strong style="color: #46e65a;">POST</strong> æ–¹æ³•</li>
                <li>å„²å­˜è¨­å®šå³å¯</li>
              </ol>
            </div>

            <div
              style="margin-top: 10px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-left: 3px solid #ff6b6b; font-size: 13px; color: #e0e0e0; line-height: 1.5;">
              <strong>âš ï¸ é‡è¦ï¼š</strong><br>
              æ‰€ç™»å…¥çš„ ECPay å•†åº—å¾Œå°å¸³è™Ÿï¼Œå¿…é ˆèˆ‡ä¸‹æ–¹ã€ŒECPay é‡‘æµè¨­å®šã€å¡«å¯«çš„ <strong>å•†åº—ä»£è™Ÿ (MerchantID)</strong> ä¸€è‡´ï¼Œå¦å‰‡ Webhook æœƒå› é©—è­‰å¤±æ•—è€Œç„¡æ³•é‹ä½œã€‚
            </div>
          </div>
        </div>

        <div
          style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border: 2px solid rgba(255, 193, 7, 0.3); border-radius: 10px;">
          <div style="font-size: 14px; color: #ffc107; margin-bottom: 8px;">ğŸ’¡ æç¤º</div>
          <ul style="color: #e0e0e0; font-size: 13px; margin-left: 20px; line-height: 1.8;">
            <li>å…©ç¨®æ–¹å¼å¯ä»¥åŒæ™‚ä½¿ç”¨ï¼Œä¸æœƒè¡çª</li>
            <li>Webhook æ–¹å¼éœ€è¦å…ˆåœ¨ä¸Šæ–¹è¨­å®š ECPay é‡‘æµè³‡è¨Š</li>
            <li>ç³»çµ±æœƒè‡ªå‹•å»é™¤é‡è¤‡çš„ææ¬¾è¨˜éŒ„</li>
            <li>å¦‚æœæ‚¨éœ€è¦è‡ªè¨‚ææ¬¾äººåç¨±å’Œç•™è¨€ï¼Œè«‹åœ¨ ECPay è¨‚å–®ä¸­ä½¿ç”¨ CustomField1 (åç¨±) å’Œ CustomField2 (ç•™è¨€)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const alertContainer = document.getElementById('alertContainer');
    const goalForm = document.getElementById('goalForm');
    const currentTotal = document.getElementById('currentTotal');
    const progressPercent = document.getElementById('progressPercent');
    const donationCount = document.getElementById('donationCount');
    const goalTitle = document.getElementById('goalTitle');
    const progressFill = document.getElementById('progressFill');
    const remainingAmount = document.getElementById('remainingAmount');
    const donationsList = document.getElementById('donationsList');
    const obsUrl = document.getElementById('obsUrl');

    // ECPay form elements
    const ecpayForm = document.getElementById('ecpayForm');
    const merchantIdInput = document.getElementById('merchantIdInput');
    const hashKeyInput = document.getElementById('hashKeyInput');
    const hashIVInput = document.getElementById('hashIVInput');

    // Overlay settings form elements
    const overlaySettingsForm = document.getElementById('overlaySettingsForm');
    const alertEnabledInput = document.getElementById('alertEnabledInput');
    const alertSoundInput = document.getElementById('alertSoundInput');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const fontColorInput = document.getElementById('fontColorInput');
    const backgroundColorInput = document.getElementById('backgroundColorInput');
    const progressBarColorInput = document.getElementById('progressBarColorInput');
    const progressBarHeightInput = document.getElementById('progressBarHeightInput');
    const progressBarCornerRadiusInput = document.getElementById('progressBarCornerRadiusInput');
    const positionInput = document.getElementById('positionInput');
    const widthInput = document.getElementById('widthInput');
    const alertDurationInput = document.getElementById('alertDurationInput');
    const donationDisplayModeInput = document.getElementById('donationDisplayModeInput');

    // Form inputs
    const goalTitleInput = document.getElementById('goalTitleInput');
    const goalAmountInput = document.getElementById('goalAmountInput');
    const goalStartFromInput = document.getElementById('goalStartFromInput');

    // Global variables to store workspace data
    let workspaceSlug = 'default';
    let workspaceUrls = {
      overlay: '/overlay',
      donate: '/donate',
      webhook: '/webhook/ecpay'
    };

    // Track if workspace URLs are already loaded
    let workspaceUrlsLoaded = false;

    // Load workspace URLs from API
    async function loadWorkspaceUrls() {
      if (workspaceUrlsLoaded) {
        console.log('â­ï¸ Workspace URLs already loaded, skipping');
        return;
      }

      try {
        const response = await fetch('/api/workspace/urls');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        if (data.success && data.urls) {
          workspaceSlug = data.urls.slug || 'default';

          // Store workspace URLs globally
          workspaceUrls = {
            overlay: data.urls.overlay,
            donate: data.urls.donate,
            webhook: data.urls.webhook
          };

          // Set OBS overlay URL
          obsUrl.textContent = workspaceUrls.overlay;

          // Set donation methods URLs
          const donatePageUrl = document.getElementById('donatePageUrl');
          const webhookUrl = document.getElementById('webhookUrl');
          if (donatePageUrl) {
            donatePageUrl.textContent = workspaceUrls.donate;
          }
          if (webhookUrl) {
            webhookUrl.textContent = workspaceUrls.webhook;
          }

          // Update overlay preview iframe
          const overlayPreview = document.getElementById('overlayPreview');
          if (overlayPreview) {
            overlayPreview.src = workspaceUrls.overlay;
          }

          // Update quick links
          const quickLinkOverlay = document.querySelector('a[href="/overlay"]');
          if (quickLinkOverlay) {
            quickLinkOverlay.href = workspaceUrls.overlay;
          }

          // Update all donate page links
          const donateLinks = document.querySelectorAll('a[href="/donate"]');
          donateLinks.forEach(link => {
            link.href = workspaceUrls.donate;
          });

          console.log('âœ… Workspace URLs loaded:', data.urls);

          workspaceUrlsLoaded = true;

          // Setup SSE connection after workspace slug is loaded
          setupSSE();
        }
      } catch (error) {
        console.error('âŒ Failed to load workspace URLs:', error);
        // Fallback to legacy URLs
        obsUrl.textContent = `${window.location.origin}/overlay`;
        const donatePageUrl = document.getElementById('donatePageUrl');
        const webhookUrl = document.getElementById('webhookUrl');
        if (donatePageUrl) {
          donatePageUrl.textContent = `${window.location.origin}/donate`;
        }
        if (webhookUrl) {
          webhookUrl.textContent = `${window.location.origin}/webhook/ecpay`;
        }

        // Setup SSE with fallback
        setupSSE();
      }
    }

    // Note: loadWorkspaceUrls is now called in initializeAdminPanel()

    // Copy to clipboard utility function
    function copyToClipboard(text, successMessage = 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿') {
      navigator.clipboard.writeText(text).then(() => {
        showAlert(successMessage, 'success');
      }).catch(err => {
        showAlert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
        console.error('Copy failed:', err);
      });
    }

    // Toggle donation methods modal
    function toggleDonationMethodsModal() {
      const modal = document.getElementById('donationMethodsModal');
      modal.classList.toggle('active');

      // Prevent body scroll when modal is open
      if (modal.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    // Toggle subscription modal
    function toggleSubscriptionModal() {
      const modal = document.getElementById('subscriptionModal');
      modal.classList.toggle('active');

      // Prevent body scroll when modal is open
      if (modal.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    // Toggle feedback modal
    function toggleFeedbackModal() {
      const modal = document.getElementById('feedbackModal');
      modal.classList.toggle('active');

      // Prevent body scroll when modal is open
      if (modal.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    // Close modal when clicking outside the content
    document.getElementById('donationMethodsModal')?.addEventListener('click', function (e) {
      if (e.target === this) {
        toggleDonationMethodsModal();
      }
    });

    document.getElementById('subscriptionModal')?.addEventListener('click', function (e) {
      if (e.target === this) {
        toggleSubscriptionModal();
      }
    });

    document.getElementById('feedbackModal')?.addEventListener('click', function (e) {
      if (e.target === this) {
        toggleFeedbackModal();
      }
    });

    // Close modal with ESC key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        const donationModal = document.getElementById('donationMethodsModal');
        const subscriptionModal = document.getElementById('subscriptionModal');
        const feedbackModal = document.getElementById('feedbackModal');

        if (donationModal?.classList.contains('active')) {
          toggleDonationMethodsModal();
        }
        if (subscriptionModal?.classList.contains('active')) {
          toggleSubscriptionModal();
        }
        if (feedbackModal?.classList.contains('active')) {
          toggleFeedbackModal();
        }
      }
    });

    function showAlert(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      setTimeout(() => {
        if (alert.parentNode) {
          alert.style.animation = 'slideInDown 0.3s ease-out reverse';
          setTimeout(() => alert.remove(), 300);
        }
      }, 5000);
    }

    function showFormFeedback(elementId, message, type = 'success') {
      const feedback = document.getElementById(elementId);
      if (feedback) {
        feedback.textContent = message;
        feedback.className = `form-feedback ${type}`;
        setTimeout(() => {
          if (feedback.textContent === message) {
            feedback.textContent = '';
            feedback.className = 'form-feedback';
          }
        }, 3000);
      }
    }

    function setButtonLoading(buttonId, loading = true) {
      const button = document.getElementById(buttonId);
      if (button) {
        if (loading) {
          button.disabled = true;
          button.classList.add('loading');
        } else {
          button.disabled = false;
          button.classList.remove('loading');
        }
      }
    }

    function pulseCard(cardElement, type = 'success') {
      if (cardElement) {
        cardElement.classList.add(`pulse-${type}`);
        setTimeout(() => {
          cardElement.classList.remove(`pulse-${type}`);
        }, 600);
      }
    }

    function formatNumber(num) {
      return (num || 0).toLocaleString('zh-TW');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('zh-TW');
    }

    function renderProgress(data) {
      const { title, current, goal, percent, donations, actualDonations, startFrom } = data;

      // Update stats - show total including startFrom
      currentTotal.textContent = `NT$ ${formatNumber(current)}`;
      progressPercent.textContent = `${percent || 0}%`;
      donationCount.textContent = donations ? donations.length : 0;

      // Update progress bar
      goalTitle.textContent = title || 'Goal';
      progressFill.style.width = `${Math.min(100, percent || 0)}%`;
      remainingAmount.textContent = formatNumber(Math.max(0, goal - current));

      // Update form with current values
      goalTitleInput.value = title || '';
      goalAmountInput.value = goal || '';
      goalStartFromInput.value = startFrom || 0;

      // Render donations list
      if (donations && donations.length > 0) {
        const donationsHTML = donations
          .slice()
          .reverse()
          .map(donation => `
            <div class="donation-item">
              <div class="donation-info">
                <div class="donation-payer">${donation.payer}</div>
                <div class="donation-amount">NT$ ${formatNumber(donation.amount)}</div>
                <div class="donation-time">${new Date(donation.at).toLocaleString('zh-TW')}</div>
              </div>
            </div>
          `).join('');

        donationsList.innerHTML = donationsHTML;
      } else {
        donationsList.innerHTML = '<div style="text-align: center; color: #a0a0a0; padding: 20px;">å°šç„¡ææ¬¾è¨˜éŒ„</div>';
      }
    }

    // Load initial data - uses logged-in user's workspace
    async function loadData() {
      try {
        console.log('ğŸ“Š Loading user-specific progress data...');
        const response = await fetch('/admin/progress');
        const data = await response.json();
        console.log('âœ… Progress data loaded:', data);
        renderProgress(data);
      } catch (error) {
        console.error('Failed to load data:', error);
        showAlert('è¼‰å…¥è³‡æ–™å¤±æ•—', 'error');
      }
    }

    // Update goal
    goalForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      setButtonLoading('goalSubmitBtn', true);
      showFormFeedback('goalFeedback', 'æ­£åœ¨æ›´æ–°ç›®æ¨™è¨­å®š...', 'info');

      const formData = {
        title: goalTitleInput.value,
        amount: parseInt(goalAmountInput.value),
        startFrom: parseInt(goalStartFromInput.value) || 0
      };

      try {
        console.log('ğŸš€ Sending goal update:', formData);

        const response = await fetch('/admin/goal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        console.log('ğŸ“¡ Response status:', response.status, response.statusText);

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error(`Server returned ${contentType || 'non-JSON'} response (status ${response.status})`);
        }

        const result = await response.json();
        console.log('ğŸ“¦ Response data:', result);

        setButtonLoading('goalSubmitBtn', false);

        if (response.ok && result.success) {
          showAlert('âœ… ç›®æ¨™è¨­å®šå·²æ›´æ–°ï¼');
          showFormFeedback('goalFeedback', 'âœ… ç›®æ¨™è¨­å®šæˆåŠŸæ›´æ–°', 'success');
          pulseCard(goalForm.closest('.card'), 'success');
          loadData(); // Refresh data
        } else {
          const errorMsg = result.error || 'æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦';
          showAlert(`âŒ ${errorMsg}`, 'error');
          showFormFeedback('goalFeedback', `âŒ ${errorMsg}`, 'error');
          pulseCard(goalForm.closest('.card'), 'error');
        }
      } catch (error) {
        console.error('âŒ Failed to update goal:', error);
        setButtonLoading('goalSubmitBtn', false);

        const errorMessage = error.message || 'ç¶²è·¯é€£ç·šéŒ¯èª¤';
        showAlert(`âŒ ${errorMessage}`, 'error');
        showFormFeedback('goalFeedback', `âŒ ${errorMessage}`, 'error');
        pulseCard(goalForm.closest('.card'), 'error');
      }
    });

    // Reset progress
    async function resetProgress() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }

      try {
        const response = await fetch('/admin/reset', {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showAlert('é€²åº¦å·²é‡ç½®ï¼');
          loadData(); // Refresh data
        } else {
          showAlert('é‡ç½®å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('Failed to reset:', error);
        showAlert('é‡ç½®å¤±æ•—', 'error');
      }
    }

    // Real-time updates via SSE
    let eventSource = null;
    let adminSseReconnectAttempts = 0;
    const ADMIN_MAX_RECONNECT_DELAY = 30000;

    function setupSSE() {
      // Close existing connection if any
      if (eventSource) {
        eventSource.close();
      }

      const eventsUrl = workspaceSlug ? `/events?slug=${workspaceSlug}` : '/events';
      console.log('ğŸ”Œ Admin SSE connecting to:', eventsUrl);
      eventSource = new EventSource(eventsUrl);

      eventSource.onopen = function () {
        console.log('âœ… Admin SSE connection established');
        adminSseReconnectAttempts = 0;
      };

      eventSource.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          renderProgress(data);
        } catch (error) {
          console.error('Error parsing SSE data:', error);
        }
      };

      eventSource.onerror = function (error) {
        console.error('âŒ Admin SSE connection error:', error);

        if (eventSource.readyState === EventSource.CLOSED) {
          adminSseReconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, adminSseReconnectAttempts), ADMIN_MAX_RECONNECT_DELAY);
          console.log(`ğŸ” Admin SSE reconnecting in ${delay / 1000}s (attempt ${adminSseReconnectAttempts})...`);

          setTimeout(() => {
            setupSSE();
          }, delay);
        }
      };
    }

    // Logout function
    function logout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/login';
          })
          .catch(() => {
            window.location.href = '/login';
          });
      }
    }

    // Load ECPay credentials
    async function loadECPayCredentials() {
      try {
        console.log('ğŸ”‘ Fetching ECPay credentials...');
        const response = await fetch('/admin/ecpay');
        console.log('ğŸ”‘ ECPay response received:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('ğŸ”‘ ECPay data parsed');
        merchantIdInput.placeholder = data.merchantId || 'è«‹è¼¸å…¥ ECPay å•†åº—ä»£è™Ÿ';
        hashKeyInput.placeholder = data.hashKey || 'è«‹è¼¸å…¥ ECPay HashKey';
        hashIVInput.placeholder = data.hashIV || 'è«‹è¼¸å…¥ ECPay HashIV';
        // Set value for merchantId to show current value
        merchantIdInput.value = data.merchantId || '';
      } catch (error) {
        console.error('Failed to load ECPay credentials:', error);
      }
    }

    // Load overlay settings
    async function loadOverlaySettings() {
      try {
        console.log('ğŸ¨ Fetching overlay settings...');
        const response = await fetch('/admin/overlay');
        console.log('ğŸ¨ Overlay settings response received:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const settings = await response.json();
        console.log('ğŸ¨ Overlay settings parsed');

        alertEnabledInput.checked = settings.alertEnabled !== false;
        alertSoundInput.checked = settings.alertSound !== false;
        fontSizeInput.value = settings.fontSize || 16;
        fontColorInput.value = settings.fontColor || '#ffffff';
        backgroundColorInput.value = settings.backgroundColor || '#1a1a1a';
        progressBarColorInput.value = settings.progressBarColor || '#46e65a';
        progressBarHeightInput.value = settings.progressBarHeight || 30;
        progressBarCornerRadiusInput.value = settings.progressBarCornerRadius || 15;
        positionInput.value = settings.position || 'top-center';
        widthInput.value = settings.width || 900;
        alertDurationInput.value = settings.alertDuration || 5000;
        donationDisplayModeInput.value = settings.donationDisplayMode || 'top';
        donationDisplayCountInput.value = settings.donationDisplayCount || 3;
      } catch (error) {
        console.error('Failed to load overlay settings:', error);
      }
    }

    // Update ECPay credentials
    ecpayForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      setButtonLoading('ecpaySubmitBtn', true);
      showFormFeedback('ecpayFeedback', 'æ­£åœ¨æ›´æ–° ECPay è¨­å®š...', 'info');

      // Only send fields that have values (for partial updates)
      const formData = {};
      if (merchantIdInput.value.trim()) formData.merchantId = merchantIdInput.value.trim();
      if (hashKeyInput.value.trim()) formData.hashKey = hashKeyInput.value.trim();
      if (hashIVInput.value.trim()) formData.hashIV = hashIVInput.value.trim();

      try {
        const response = await fetch('/admin/ecpay', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        setButtonLoading('ecpaySubmitBtn', false);

        if (result.success) {
          showAlert('âœ… ECPay é‡‘æµè¨­å®šå·²æ›´æ–°ï¼');
          showFormFeedback('ecpayFeedback', 'âœ… ECPay è¨­å®šæˆåŠŸæ›´æ–°', 'success');
          pulseCard(ecpayForm.closest('.card'), 'success');
          // Clear all fields after successful update
          merchantIdInput.value = '';
          hashKeyInput.value = '';
          hashIVInput.value = '';
          loadECPayCredentials(); // Reload to show updated values in placeholders
        } else {
          showAlert(`âŒ ${result.error || 'æ›´æ–°å¤±æ•—'}`, 'error');
          showFormFeedback('ecpayFeedback', `âŒ ${result.error || 'æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦'}`, 'error');
          pulseCard(ecpayForm.closest('.card'), 'error');
        }
      } catch (error) {
        console.error('Failed to update ECPay credentials:', error);
        setButtonLoading('ecpaySubmitBtn', false);
        showAlert('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
        showFormFeedback('ecpayFeedback', 'âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š', 'error');
        pulseCard(ecpayForm.closest('.card'), 'error');
      }
    });

    // Update overlay settings
    overlaySettingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      setButtonLoading('overlaySubmitBtn', true);
      showFormFeedback('overlayFeedback', 'æ­£åœ¨æ›´æ–°æ–—å…§æ¢è¨­å®š...', 'info');

      const settings = {
        alertEnabled: alertEnabledInput.checked,
        alertSound: alertSoundInput.checked,
        fontSize: parseInt(fontSizeInput.value),
        fontColor: fontColorInput.value,
        backgroundColor: backgroundColorInput.value,
        progressBarColor: progressBarColorInput.value,
        progressBarHeight: parseInt(progressBarHeightInput.value),
        progressBarCornerRadius: parseInt(progressBarCornerRadiusInput.value),
        position: positionInput.value,
        width: parseInt(widthInput.value),
        alertDuration: parseInt(alertDurationInput.value),
        donationDisplayMode: donationDisplayModeInput.value,
        donationDisplayCount: parseInt(donationDisplayCountInput.value)
      };

      try {
        const response = await fetch('/admin/overlay', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });

        const result = await response.json();

        setButtonLoading('overlaySubmitBtn', false);

        if (result.success) {
          showAlert('âœ… æ–—å…§æ¢å¤–è§€è¨­å®šå·²æ›´æ–°ï¼');
          showFormFeedback('overlayFeedback', 'âœ… æ–—å…§æ¢è¨­å®šæˆåŠŸæ›´æ–°', 'success');
          pulseCard(overlaySettingsForm.closest('.card'), 'success');
          // Auto-refresh preview to show updated settings
          setTimeout(() => {
            const iframe = document.getElementById('overlayPreview');
            if (iframe) iframe.src = iframe.src;
          }, 500);
        } else {
          showAlert(`âŒ ${result.error || 'æ›´æ–°å¤±æ•—'}`, 'error');
          showFormFeedback('overlayFeedback', `âŒ ${result.error || 'æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦'}`, 'error');
          pulseCard(overlaySettingsForm.closest('.card'), 'error');
        }
      } catch (error) {
        console.error('Failed to update overlay settings:', error);
        setButtonLoading('overlaySubmitBtn', false);
        showAlert('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
        showFormFeedback('overlayFeedback', 'âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š', 'error');
        pulseCard(overlaySettingsForm.closest('.card'), 'error');
      }
    });

    // Overlay Preview Functions
    function refreshOverlayPreview() {
      const iframe = document.getElementById('overlayPreview');
      iframe.src = iframe.src; // Force reload
      showAlert('ğŸ”„ é è¦½å·²é‡æ–°æ•´ç†');
    }

    let previewExpanded = false;
    function togglePreviewSize() {
      const iframe = document.getElementById('overlayPreview');
      previewExpanded = !previewExpanded;

      if (previewExpanded) {
        iframe.style.height = '600px';
        showAlert('ğŸ“ é è¦½å·²æ”¾å¤§');
      } else {
        iframe.style.height = '400px';
        showAlert('ğŸ“ é è¦½å·²ç¸®å°');
      }
    }

    // Load User and Subscription Info
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user/info');
        const data = await response.json();

        if (data.success) {
          // Update user info
          document.getElementById('userName').textContent = data.user.displayName || data.user.username;
          document.getElementById('userEmail').textContent = data.user.email;
          document.getElementById('userAvatar').textContent = (data.user.displayName || data.user.username).charAt(0).toUpperCase();

          // Load subscription info
          if (data.subscription) {
            renderSubscriptionStatus(data.subscription);
          }
        }
      } catch (error) {
        console.error('Failed to load user info:', error);
      }
    }

    // Render Subscription Status
    function renderSubscriptionStatus(subscription) {
      const badge = document.getElementById('subscriptionBadge');
      const statusContainer = document.getElementById('subscriptionStatus');
      const managementContainer = document.getElementById('subscriptionManagement');

      // Update badge
      const badgeText = subscription.planType === 'trial' ? 'è©¦ç”¨ä¸­' :
        subscription.planType === 'paid' || subscription.planType === 'pro' ? 'ä»˜è²»æ–¹æ¡ˆ' :
          subscription.planType === 'free_pass' ? 'FREE PASS' : 'å…è²»æ–¹æ¡ˆ';
      badge.textContent = badgeText;
      badge.className = `subscription-badge ${subscription.planType}`;

      // Calculate trial days remaining
      const now = new Date();
      const trialEnd = subscription.trialEndDate ? new Date(subscription.trialEndDate) : null;
      const daysRemaining = trialEnd ? Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24)) : 0;

      let statusHTML = '';

      // Trial Warning
      if (subscription.isTrial && daysRemaining > 0) {
        const urgentClass = daysRemaining <= 3 ? 'urgent' : '';
        statusHTML += `
          <div class="trial-warning ${urgentClass}">
            <strong>â° è©¦ç”¨æœŸæé†’</strong><br>
            æ‚¨çš„è©¦ç”¨æœŸé‚„å‰© <strong>${daysRemaining} å¤©</strong>ï¼ˆåˆ°æœŸæ—¥ï¼š${trialEnd.toLocaleDateString('zh-TW')}ï¼‰<br>
            ${daysRemaining <= 7 ? 'è«‹ç›¡å¿«å‡ç´šä»¥ç¹¼çºŒä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼' : ''}
          </div>
        `;
      }

      // Trial Expired
      if (subscription.isTrial && daysRemaining <= 0) {
        statusHTML += `
          <div class="trial-warning urgent">
            <strong>âš ï¸ è©¦ç”¨æœŸå·²çµæŸ</strong><br>
            æ‚¨çš„è©¦ç”¨æœŸå·²æ–¼ ${trialEnd.toLocaleDateString('zh-TW')} çµæŸã€‚è«‹å‡ç´šæ–¹æ¡ˆä»¥ç¹¼çºŒä½¿ç”¨ã€‚
          </div>
        `;
      }

      // Free Plan Warning (show directly, no need to click button)
      if (subscription.planType === 'free' && !subscription.isTrial) {
        statusHTML += `
          <div class="trial-warning urgent" style="background: rgba(255, 107, 107, 0.15); border-color: #ff6b6b;">
            <strong>âš ï¸ æ–—å…§æ¢å’Œææ¬¾é é¢å·²åœç”¨</strong><br>
            æ‚¨ç›®å‰ä½¿ç”¨å…è²»æ–¹æ¡ˆï¼Œè«‹è¨‚é–±ä»˜è²»æ–¹æ¡ˆä»¥ç¹¼çºŒä½¿ç”¨æœå‹™<br>
            <span style="font-size: 14px; color: #a0a0a0;">æ¯æœˆåƒ…éœ€ NT$ 70ï¼Œäº«æœ‰å®Œæ•´åŠŸèƒ½</span>
          </div>
        `;
      }

      statusContainer.innerHTML = statusHTML;

      // Render Subscription Management
      let managementHTML = '';

      if (subscription.planType === 'free_pass') {
        managementHTML = `
          <div style="background: rgba(138, 43, 226, 0.1); padding: 25px; border-radius: 12px; border: 2px solid #BA55D3; margin-top: 15px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <span style="font-size: 60px;">ğŸ</span>
            </div>
            
            <!-- Plan Title Card -->
            <div style="background: rgba(138, 43, 226, 0.15); padding: 16px 20px; border-radius: 10px; border: 1px solid rgba(186, 85, 211, 0.3); margin-bottom: 20px;">
              <h3 style="text-align: center; margin: 0; color: #BA55D3; font-size: 22px; font-weight: 700;">ğŸ‰ Free Pass ç”¨æˆ¶</h3>
            </div>
            <p style="text-align: center; color: #e0e0e0; margin-bottom: 20px; font-size: 15px;">
              æ‚¨æ“æœ‰æ°¸ä¹…å…è²»ä½¿ç”¨æ¬Šé™ï¼Œäº«æœ‰æ‰€æœ‰åŠŸèƒ½ï¼
            </p>
            <ul class="plan-features" style="margin-top: 20px;">
              <li>ç„¡é™åˆ¶ææ¬¾æ¬¡æ•¸</li>
              <li>ç„¡é™åˆ¶ API å‘¼å«</li>
              <li>é€²éšæ–—å…§æ¢è‡ªè¨‚</li>
              <li>å„ªå…ˆæŠ€è¡“æ”¯æ´</li>
              <li>æ°¸ä¹…æœ‰æ•ˆï¼Œç„¡éœ€ä»˜è²»</li>
            </ul>
          </div>
        `;
      } else if (subscription.planType === 'free' || (subscription.isTrial && daysRemaining <= 0)) {
        // Expired trial or free plan - URLs disabled
        const isExpired = subscription.isTrial && daysRemaining <= 0;
        managementHTML = `
          <div style="margin-top: 15px;">
            <div style="background: rgba(255, 107, 107, 0.1); padding: 25px; border-radius: 12px; border: 2px solid #ff6b6b;">
              <div style="text-align: center; margin-bottom: 20px;">
                <span style="font-size: 60px;">ğŸš«</span>
              </div>
              
              <!-- Plan Title Card -->
              <div style="background: rgba(255, 107, 107, 0.15); padding: 16px 20px; border-radius: 10px; border: 1px solid rgba(255, 107, 107, 0.3); margin-bottom: 20px;">
                <h3 style="text-align: center; margin: 0; color: #ff6b6b; font-size: 22px; font-weight: 700;">âš ï¸ ${isExpired ? 'è©¦ç”¨æœŸå·²çµæŸ' : 'ç›®å‰æ–¹æ¡ˆï¼šå…è²»æ–¹æ¡ˆ'}</h3>
              </div>
              <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 16px; color: #ff6b6b; line-height: 1.8;">
                  <div style="margin-bottom: 10px;"><strong>âš ï¸ æ–—å…§æ¢å’Œææ¬¾é é¢å·²åœç”¨</strong></div>
                  <div style="font-size: 14px; color: #e0e0e0;">
                    ${isExpired ? 'æ‚¨çš„è©¦ç”¨æœŸå·²çµæŸï¼Œ' : ''}è«‹è¨‚é–±ä»˜è²»æ–¹æ¡ˆä»¥ç¹¼çºŒä½¿ç”¨æœå‹™
                  </div>
                </div>
              </div>
              <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #a0a0a0; margin-bottom: 10px;">ğŸ’° ä»˜è²»æ–¹æ¡ˆ</div>
                <div style="color: #e0e0e0; font-size: 15px;">
                  <div style="margin-bottom: 5px;">æ¯æœˆåƒ…éœ€ <strong style="color: #46e65a;">NT$ 70</strong></div>
                  <div style="font-size: 13px; color: #a0a0a0;">ç„¡ä½¿ç”¨é™åˆ¶ï¼Œå®Œæ•´åŠŸèƒ½</div>
                </div>
              </div>
              <ul class="plan-features">
                <li>ç„¡é™åˆ¶ææ¬¾æ¬¡æ•¸</li>
                <li>ç„¡é™åˆ¶ API å‘¼å«</li>
                <li>å®Œæ•´æ–—å…§æ¢åŠŸèƒ½</li>
                <li>é€²éšæ–—å…§æ¢è‡ªè¨‚</li>
                <li>å„ªå…ˆæŠ€è¡“æ”¯æ´</li>
              </ul>
              <button class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 16px; padding: 14px;" onclick="upgradePlan()">
                ğŸ’³ è¨‚é–±ä»˜è²»æ–¹æ¡ˆ (NT$ 70/æœˆ)
              </button>
            </div>
          </div>
        `;
      } else if (subscription.isTrial && daysRemaining > 0) {
        const urgentClass = daysRemaining <= 3 ? 'urgent' : '';
        const bgColor = daysRemaining <= 3 ? 'rgba(255, 107, 107, 0.1)' : 'rgba(52, 152, 219, 0.1)';
        const borderColor = daysRemaining <= 3 ? '#ff6b6b' : '#3498db';
        const textColor = daysRemaining <= 3 ? '#ff6b6b' : '#3498db';

        managementHTML = `
          <div style="margin-top: 15px;">
            <div style="background: ${bgColor}; padding: 25px; border-radius: 12px; border: 2px solid ${borderColor};">
              <div style="text-align: center; margin-bottom: 20px;">
                <span style="font-size: 60px;">â°</span>
              </div>
              
              <!-- Plan Title Card -->
              <div style="background: rgba(52, 152, 219, 0.15); padding: 16px 20px; border-radius: 10px; border: 1px solid rgba(52, 152, 219, 0.3); margin-bottom: 20px;">
                <h3 style="text-align: center; margin: 0; color: ${textColor}; font-size: 22px; font-weight: 700;">ğŸ† è©¦ç”¨æœŸé–“</h3>
              </div>
              
              <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 16px; color: #e0e0e0; margin-bottom: 10px;">è©¦ç”¨æœŸé™</div>
                <div style="font-size: 32px; font-weight: bold; color: ${textColor}; margin-bottom: 5px;">${daysRemaining}</div>
                <div style="font-size: 18px; color: ${textColor};">å¤©å‰©é¤˜</div>
                <div style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">åˆ°æœŸæ—¥ï¼š${trialEnd.toLocaleDateString('zh-TW')}</div>
              </div>
              
              <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #a0a0a0; margin-bottom: 10px;">ğŸ’° è¨‚é–±å¾Œåƒ¹æ ¼</div>
                <div style="color: #e0e0e0; font-size: 15px;">
                  <div>æ¯æœˆåƒ…éœ€ <strong style="color: #46e65a;">NT$ 70</strong></div>
                </div>
              </div>
              <ul class="plan-features">
                <li>ç„¡é™åˆ¶ææ¬¾æ¬¡æ•¸</li>
                <li>ç„¡é™åˆ¶ API å‘¼å«</li>
                <li>å®Œæ•´æ–—å…§æ¢åŠŸèƒ½</li>
                <li>é€²éšæ–—å…§æ¢è‡ªè¨‚</li>
                <li>å„ªå…ˆæŠ€è¡“æ”¯æ´</li>
              </ul>
              <button class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 16px; padding: 14px;" onclick="upgradePlan()">
                ğŸ’³ è¨‚é–±ä»˜è²»æ–¹æ¡ˆ (NT$ 70/æœˆ)
              </button>
            </div>
          </div>
        `;
      } else {
        // Paid subscription - full management interface
        // Calculate next billing date if not present
        let nextBillingDate = subscription.nextBillingDate;
        if (!nextBillingDate && subscription.billingCycleStart) {
          const nextDate = new Date(subscription.billingCycleStart);
          nextDate.setMonth(nextDate.getMonth() + 1); // Add 1 month
          nextBillingDate = nextDate.toISOString();
        }

        const nextBillingFormatted = nextBillingDate
          ? new Date(nextBillingDate).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })
          : '-';

        managementHTML = `
          <div style="margin-top: 15px;">
            <div style="background: rgba(70, 230, 90, 0.1); padding: 25px; border-radius: 12px; border: 2px solid #46e65a;">
              <div style="text-align: center; margin-bottom: 20px;">
                <span style="font-size: 60px;">âœ…</span>
              </div>
              
              <!-- Plan Title Card -->
              <div style="background: rgba(70, 230, 90, 0.15); padding: 16px 20px; border-radius: 10px; border: 1px solid rgba(70, 230, 90, 0.3); margin-bottom: 20px;">
                <h3 style="text-align: center; margin: 0; color: #46e65a; font-size: 22px; font-weight: 700;">ğŸ’ ä»˜è²»æ–¹æ¡ˆ</h3>
              </div>
              
              <!-- Subscription Details -->
              <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <div style="font-size: 12px; color: #a0a0a0; margin-bottom: 5px;">è¨‚é–±ç‹€æ…‹</div>
                    <div style="font-size: 16px; color: #46e65a; font-weight: bold;">â— å•Ÿç”¨ä¸­</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #a0a0a0; margin-bottom: 5px;">æœˆè²»</div>
                    <div style="font-size: 16px; color: #e0e0e0; font-weight: bold;">NT$ 70</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #a0a0a0; margin-bottom: 5px;">é–‹å§‹æ—¥æœŸ</div>
                    <div style="font-size: 14px; color: #e0e0e0;">
                      ${subscription.billingCycleStart ? new Date(subscription.billingCycleStart).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' }) : '-'}
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #a0a0a0; margin-bottom: 5px;">ä¸‹æ¬¡æ‰£æ¬¾</div>
                    <div style="font-size: 14px; color: #e0e0e0;">${nextBillingFormatted}</div>
                  </div>
                </div>
              </div>
              
              <!-- Features -->
              <ul class="plan-features">
                <li>ç„¡é™åˆ¶ææ¬¾æ¬¡æ•¸</li>
                <li>ç„¡é™åˆ¶ API å‘¼å«</li>
                <li>å®Œæ•´æ–—å…§æ¢åŠŸèƒ½</li>
                <li>é€²éšæ–—å…§æ¢è‡ªè¨‚</li>
                <li>å„ªå…ˆæŠ€è¡“æ”¯æ´</li>
              </ul>
              
              <!-- Payment History Section (Placeholder) -->
              <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #e0e0e0; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                  <span><strong>ğŸ“œ ä»˜æ¬¾ç´€éŒ„</strong></span>
                  <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="viewPaymentHistory()">
                    æŸ¥çœ‹å…¨éƒ¨
                  </button>
                </div>
                <div id="paymentHistoryPreview" style="font-size: 13px; color: #a0a0a0;">
                  <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between;">
                      <span>æœ€è¿‘ä¸€æ¬¡ä»˜æ¬¾</span>
                      <span style="color: #46e65a;">å¾…ä¸²æ¥</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Invoice Section (Placeholder) -->
              <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #e0e0e0; margin-bottom: 10px;">
                  <strong>ğŸ§¾ é›»å­ç™¼ç¥¨</strong>
                </div>
                <div style="font-size: 13px; color: #a0a0a0;">
                  <div style="padding: 8px 0;">
                    å•Ÿç”¨å¾Œæ¯æ¬¡æ‰£æ¬¾å°‡è‡ªå‹•é–‹ç«‹é›»å­ç™¼ç¥¨
                  </div>
                  <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;" onclick="manageInvoice()">
                    è¨­å®šç™¼ç¥¨è³‡è¨Š
                  </button>
                </div>
              </div>
              
              <!-- Management Actions -->
              <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" style="font-size: 14px; padding: 12px;" onclick="manageBilling()">
                  ğŸ’³ ç®¡ç†ä»˜æ¬¾æ–¹å¼
                </button>
                <div style="display: flex; gap: 10px;">
                  <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 10px;" onclick="pauseSubscription()">
                    â¸ï¸ æš«åœè¨‚é–±
                  </button>
                  <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 10px; background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; color: #ff6b6b;" onclick="cancelSubscription()">
                    âŒ å–æ¶ˆè¨‚é–±
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      managementContainer.innerHTML = managementHTML;
    }

    // Subscription Management Functions
    function upgradePlan() {
      // TODO: Redirect to ECPay subscription payment page
      showAlert('ğŸ’ å³å°‡å‰å¾€ ECPay ä»˜æ¬¾é é¢ï¼ˆå¾…ä¸²æ¥ï¼‰', 'info');
      // Future: window.location.href = '/subscription/checkout';
    }

    function manageBilling() {
      // TODO: Show payment method management modal
      // Should allow:
      // - View current payment method (last 4 digits of card)
      // - Update payment method
      // - Change billing address
      showAlert('ğŸ’³ ä»˜æ¬¾æ–¹å¼ç®¡ç†åŠŸèƒ½ï¼ˆå¾…ä¸²æ¥ ECPayï¼‰', 'info');
    }

    function cancelSubscription() {
      if (confirm('ç¢ºå®šè¦å–æ¶ˆè¨‚é–±å—ï¼Ÿ\n\nå–æ¶ˆå¾Œï¼š\n- æœ¬æœŸçµæŸå¾Œå°‡ç„¡æ³•ä½¿ç”¨ä»˜è²»åŠŸèƒ½\n- æ–—å…§æ¢å’Œææ¬¾é é¢å°‡è¢«åœç”¨\n- å¯éš¨æ™‚é‡æ–°è¨‚é–±')) {
        // TODO: Call API to cancel subscription
        // POST /api/subscription/cancel
        // Should update subscription status to 'canceled'
        // Should set canceledAt timestamp
        // Should still allow access until nextBillingDate
        showAlert('âš ï¸ å–æ¶ˆè¨‚é–±åŠŸèƒ½ï¼ˆå¾…ä¸²æ¥ï¼‰', 'info');
      }
    }

    function pauseSubscription() {
      if (confirm('ç¢ºå®šè¦æš«åœè¨‚é–±å—ï¼Ÿ\n\næš«åœæœŸé–“ï¼š\n- ä¸æœƒæ‰£æ¬¾\n- ç„¡æ³•ä½¿ç”¨ä»˜è²»åŠŸèƒ½\n- å¯éš¨æ™‚æ¢å¾©è¨‚é–±')) {
        // TODO: Call API to pause subscription
        // POST /api/subscription/pause
        // Should update subscription status to 'paused'
        // Should set pausedAt timestamp
        showAlert('â¸ï¸ æš«åœè¨‚é–±åŠŸèƒ½ï¼ˆå¾…ä¸²æ¥ï¼‰', 'info');
      }
    }

    function viewPaymentHistory() {
      // TODO: Show payment history modal
      // Should display:
      // - Date of payment
      // - Amount paid
      // - Payment method (last 4 digits)
      // - Status (success/failed/pending)
      // - Invoice download link
      // - Receipt download link
      showAlert('ğŸ“œ ä»˜æ¬¾ç´€éŒ„æŸ¥çœ‹åŠŸèƒ½ï¼ˆå¾…ä¸²æ¥ï¼‰', 'info');
      // Future: Display modal with payment history from ECPay query API
    }

    function manageInvoice() {
      // TODO: Show invoice settings modal
      // Should allow:
      // - Set buyer tax ID (çµ±ç·¨)
      // - Set invoice type (å€‹äºº/å…¬å¸)
      // - Set company name
      // - Set invoice email
      // - Enable/disable automatic invoice
      showAlert('ğŸ§¾ é›»å­ç™¼ç¥¨è¨­å®šåŠŸèƒ½ï¼ˆå¾…ä¸²æ¥ ECPay ç™¼ç¥¨ APIï¼‰', 'info');
    }

    // Feedback Form
    const feedbackForm = document.getElementById('feedbackForm');
    feedbackForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById('feedbackSubmitBtn');
      const feedbackFeedback = document.getElementById('feedbackFeedback');

      setButtonLoading('feedbackSubmitBtn', true);
      showFormFeedback('feedbackFeedback', '');

      const formData = {
        type: document.getElementById('feedbackType').value,
        message: document.getElementById('feedbackMessage').value
      };

      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        setButtonLoading('feedbackSubmitBtn', false);

        if (result.success) {
          // Check if Easter egg was activated
          if (result.specialReward) {
            // ğŸ‰ SPECIAL CELEBRATION FOR FREE PASS! ğŸ‰
            showAlert('ğŸŠğŸ‰ ' + result.message + ' ğŸğŸŠ', 'success');
            showFormFeedback('feedbackFeedback', 'ğŸ‰ ' + result.message, 'success');

            // Reload subscription status to show free_pass
            setTimeout(async () => {
              try {
                const userResponse = await fetch('/api/user/info');
                const userData = await userResponse.json();
                if (userData.success && userData.subscription) {
                  renderSubscriptionStatus(userData.subscription);
                }
              } catch (e) {
                console.error('Failed to reload subscription:', e);
              }
            }, 1000);

            // Close modal after celebration
            setTimeout(() => {
              toggleFeedbackModal();
              feedbackForm.reset();
            }, 3000);
          } else {
            // Normal feedback submission
            showAlert('âœ… æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼æˆ‘å€‘æœƒä»”ç´°é–±è®€æ‚¨çš„æ„è¦‹ã€‚');
            showFormFeedback('feedbackFeedback', 'âœ… å›é¥‹å·²æˆåŠŸæäº¤', 'success');
            feedbackForm.reset();
            // Close modal after successful submission
            setTimeout(() => {
              toggleFeedbackModal();
            }, 1500);
          }
        } else {
          showAlert('âŒ æäº¤å¤±æ•—', 'error');
          showFormFeedback('feedbackFeedback', 'âŒ æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
        }
      } catch (error) {
        console.error('Failed to submit feedback:', error);
        setButtonLoading('feedbackSubmitBtn', false);
        showAlert('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤', 'error');
        showFormFeedback('feedbackFeedback', 'âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š', 'error');
      }
    });

    // Helper: Add timeout to promises
    function withTimeout(promise, ms, name) {
      return Promise.race([
        promise,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`${name} timed out after ${ms}ms`)), ms)
        )
      ]);
    }

    // Initialize with error handling
    async function initializeAdminPanel() {
      console.log('ğŸš€ Initializing admin panel...');

      try {
        console.log('1ï¸âƒ£ Loading user info...');
        await withTimeout(loadUserInfo(), 10000, 'loadUserInfo');
        console.log('âœ… User info loaded');
      } catch (error) {
        console.error('âŒ Failed to load user info:', error);
        showAlert('âš ï¸ ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š', 'error');
      }

      try {
        console.log('2ï¸âƒ£ Loading workspace URLs...');
        await withTimeout(loadWorkspaceUrls(), 10000, 'loadWorkspaceUrls');
        console.log('âœ… Workspace URLs loaded');
      } catch (error) {
        console.error('âŒ Failed to load workspace URLs:', error);
        showAlert('âš ï¸ ç„¡æ³•è¼‰å…¥å·¥ä½œå€ç¶²å€', 'error');
      }

      try {
        console.log('3ï¸âƒ£ Loading progress data...');
        await withTimeout(loadData(), 10000, 'loadData');
        console.log('âœ… Progress data loaded');
      } catch (error) {
        console.error('âŒ Failed to load progress data:', error);
        showAlert('âš ï¸ ç„¡æ³•è¼‰å…¥é€²åº¦è³‡æ–™', 'error');
      }

      try {
        console.log('4ï¸âƒ£ Loading ECPay credentials...');
        await withTimeout(loadECPayCredentials(), 15000, 'loadECPayCredentials');
        console.log('âœ… ECPay credentials loaded');
      } catch (error) {
        console.error('âŒ Failed to load ECPay credentials:', error);
        console.warn('âš ï¸ This is not critical - you can still configure ECPay later');
      }

      try {
        console.log('5ï¸âƒ£ Loading overlay settings...');
        await withTimeout(loadOverlaySettings(), 15000, 'loadOverlaySettings');
        console.log('âœ… Overlay settings loaded');
      } catch (error) {
        console.error('âŒ Failed to load overlay settings:', error);
        console.warn('âš ï¸ This is not critical - you can still configure overlay later');
      }

      console.log('ğŸ‰ Admin panel initialized!');
    }

    // Start initialization
    initializeAdminPanel();

    // =============================================
    // SSE: Real-time updates and admin notifications
    // =============================================
    let currentWorkspaceSlug = null;

    function initSSE() {
      // Get workspace slug from URL if available
      const slug = currentWorkspaceSlug || 'default';
      const url = `/events?slug=${slug}`;

      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(url);

      eventSource.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          if (!data.error) {
            renderProgress(data);
          }
        } catch (error) {
          console.error('Error parsing SSE data:', error);
        }
      };

      // Listen for admin notifications (webhook warnings/errors)
      eventSource.addEventListener('admin-notification', function (event) {
        try {
          const notification = JSON.parse(event.data);
          showWebhookNotification(notification);
        } catch (error) {
          console.error('Error parsing admin notification:', error);
        }
      });

      eventSource.onerror = function (error) {
        console.error('SSE connection error:', error);
        // Reconnect after 5 seconds
        setTimeout(() => {
          if (eventSource.readyState === EventSource.CLOSED) {
            initSSE();
          }
        }, 5000);
      };
    }

    // Display webhook notifications
    function showWebhookNotification(notification) {
      const { type, message, details, timestamp } = notification;

      const icons = {
        warning: 'âš ï¸',
        error: 'âŒ',
        info: 'â„¹ï¸'
      };

      const notifEl = document.createElement('div');
      notifEl.className = `webhook-notification ${type}`;

      let detailsHtml = '';
      if (details) {
        const detailsText = Object.entries(details)
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        detailsHtml = `<div class="details">${detailsText}</div>`;
      }

      const time = new Date(timestamp).toLocaleTimeString('zh-TW');

      notifEl.innerHTML = `
        <span class="icon">${icons[type] || 'ğŸ“¡'}</span>
        <div class="content">
          <div class="message">${message}</div>
          ${detailsHtml}
          <div class="time">${time}</div>
        </div>
        <button class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
      `;

      alertContainer.insertBefore(notifEl, alertContainer.firstChild);

      // Auto-remove after 30 seconds
      setTimeout(() => {
        if (notifEl.parentNode) {
          notifEl.style.animation = 'slideInDown 0.3s ease-out reverse';
          setTimeout(() => notifEl.remove(), 300);
        }
      }, 30000);
    }

    // Set workspace slug when URLs are loaded and init SSE
    const originalLoadWorkspaceUrls = loadWorkspaceUrls;
    loadWorkspaceUrls = async function () {
      await originalLoadWorkspaceUrls();
      // Get slug from the loaded URL
      const webhookUrl = document.getElementById('webhookUrl')?.textContent || '';
      const match = webhookUrl.match(/\/webhook\/([^/]+)/);
      if (match) {
        currentWorkspaceSlug = match[1];
      }
      // Initialize SSE after workspace is loaded
      initSSE();
    };
  </script>
</body>

</html>